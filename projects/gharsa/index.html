<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Gharsa's Eye | Abdullah Ahmed Alzahrani </title> <meta name="author" content="Abdullah Ahmed Alzahrani"> <meta name="description" content="Project Walkthrough"> <meta name="keywords" content="Abdullah-Alzahrani, Abdullah-Ahmed-Alzahrani, ML-Engineer, AI-Engineer, Electrical-Engineer"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://abodeza.github.io/projects/gharsa/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Abdullah</span> Ahmed Alzahrani </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/certificates/">awards &amp; certificates </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Gharsa's Eye</h1> <p class="post-description">Project Walkthrough</p> </header> <article> <ul> <li><a href="#set-up">Set-up</a></li> <li> <a href="#helper-functions">Helper functions</a> <ul> <li><a href="#disply-annotations">Disply Annotations</a></li> <li><a href="#color-masking">Color Masking</a></li> <li><a href="#crop-segments-made-by-sam">Crop Segments Made by SAM</a></li> </ul> </li> <li> <a href="#automatic-mask-generation">Automatic Mask Generation</a> <ul> <li><a href="#instantiate-sam">Instantiate SAM</a></li> <li><a href="#prepare-test-images">Prepare test images</a></li> <li><a href="#generate-masks">Generate masks</a></li> <li><a href="#lets-visualize-the-automatically-generated-masks">Let’s visualize the automatically generated masks</a></li> <li><a href="#we-can-do-better">We can do better</a></li> <li><a href="#crop-segments-for-analysis">Crop segments for analysis</a></li> </ul> </li> <li><a href="#load-and-setup-clip">Load and setup CLIP</a></li> <li><a href="#full-pipeline-wip">Full pipeline [WIP]</a></li> <li><a href="#more-examples-wip">More examples [WIP]</a></li> <li><a href="#resources">Resources</a></li> </ul> <p><strong>Gharsa</strong> is a smart AI assistant designed for beginners and plant lovers who want to grow healthy plants but lack expert guidance.</p> <p><strong>Gharsa’s Eye</strong> focuses on detecting and classifying plant leaf diseases using just an image, making plant care more accessible.</p> <p>In this notebook, I’ll walk you through inventive techniques that tackle two major challenges in the field: the <strong>scarcity of labeled data</strong>, and the <strong>obscurity of small details in zoomed-out images</strong>. We’ll use a blend of classic and modern computer vision methods to build a reliable disease detection pipeline from scratch.</p> <blockquote> <p>This work builds on a CLIP model I finetuned with a classification accuracy of &gt;90%.</p> </blockquote> <p>We start with installing all required libraries</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># First is the SAM library and all of its dependencies
</span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="sh">'</span><span class="s">git+https://github.com/facebookresearch/segment-anything.git</span><span class="sh">'</span>

<span class="c1"># To view SAM masks
</span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">opencv</span><span class="o">-</span><span class="n">python</span> <span class="n">matplotlib</span>

<span class="c1"># Get a checkpoint of SAM
</span><span class="err">!</span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">dl</span><span class="p">.</span><span class="n">fbaipublicfiles</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">segment_anything</span><span class="o">/</span><span class="n">sam_vit_h_4b8939</span><span class="p">.</span><span class="n">pth</span>
</code></pre></div></div> <h1 id="set-up">Set-up</h1> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">torchvision</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">cv2</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">PyTorch version:</span><span class="sh">"</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Torchvision version:</span><span class="sh">"</span><span class="p">,</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">CUDA is available:</span><span class="sh">"</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">())</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cuda:0</span><span class="sh">'</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PyTorch version: 2.6.0+cu124
Torchvision version: 0.21.0+cu124
CUDA is available: True
</code></pre></div></div> <h1 id="helper-functions">Helper functions</h1> <p>##1. Disply Annotations show_anns’ <a href="https://github.com/facebookresearch/segment-anything/blob/main/notebooks/automatic_mask_generator_example.ipynb" rel="external nofollow noopener" target="_blank">credits</a></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">show_anns</span><span class="p">(</span><span class="n">anns</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">anns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">sorted_anns</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">anns</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">'</span><span class="s">area</span><span class="sh">'</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_autoscale_on</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">((</span><span class="n">sorted_anns</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">segmentation</span><span class="sh">'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sorted_anns</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">segmentation</span><span class="sh">'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">img</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">sorted_anns</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">ann</span><span class="p">[</span><span class="sh">'</span><span class="s">segmentation</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">color_mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]])</span>
        <span class="n">img</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_mask</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div></div> <h2 id="2-color-masking">2. Color Masking</h2> <p>Here is a pipeline I created to highlight the possibly diseased areas in the leaf. You can learn how to make one from my blog section found on my <a href="https://medium.com/@abodeza/masking-diseases-on-plant-leaves-6b43b7d8212f" rel="external nofollow noopener" target="_blank">medium article</a>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">color_mask</span><span class="p">(</span><span class="n">img_path</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="c1"># Read the image
</span>
    <span class="c1"># Convert the color standard to HSV
</span>    <span class="n">hsv</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2HSV</span><span class="p">)</span>

    <span class="c1"># Find the leaf
</span>    <span class="n">leaf_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span> <span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

    <span class="c1"># Create a black 1-channel image to draw on the leaf mask
</span>    <span class="n">leaf</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">leaf_mask</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># Get the outermost contour
</span>    <span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">findContours</span><span class="p">(</span><span class="n">leaf_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

    <span class="c1"># Draw contours on the black image
</span>    <span class="n">cv2</span><span class="p">.</span><span class="nf">drawContours</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">FILLED</span><span class="p">)</span>

    <span class="c1"># Construct the powdery mildew mask
</span>    <span class="n">mildew_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="p">(</span><span class="mi">180</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

    <span class="c1"># Construct the spots mask
</span>    <span class="n">spot_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

    <span class="c1"># Construct the rot mask
</span>    <span class="n">rot_mask1</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">100</span><span class="p">))</span>
    <span class="n">rot_mask2</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
    <span class="n">rot_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_or</span><span class="p">(</span><span class="n">rot_mask1</span><span class="p">,</span> <span class="n">rot_mask2</span><span class="p">)</span>

    <span class="c1"># Combine the mildew, spot and rot masks then confine within the leaf - others can appear on edges
</span>    <span class="n">temp_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_or</span><span class="p">(</span><span class="n">mildew_mask</span><span class="p">,</span> <span class="n">spot_mask</span><span class="p">)</span>
    <span class="n">temp_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_or</span><span class="p">(</span><span class="n">temp_mask</span><span class="p">,</span> <span class="n">rot_mask</span><span class="p">)</span>
    <span class="n">temp_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_and</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">leaf</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">temp_mask</span><span class="p">)</span>

    <span class="c1"># Construct the burn mask
</span>    <span class="n">burn_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

    <span class="c1"># Construct the chlorosis mask
</span>    <span class="n">chlorosis_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">inRange</span><span class="p">(</span><span class="n">hsv</span><span class="p">,</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

    <span class="c1"># Combine disease masks
</span>    <span class="n">disease_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_or</span><span class="p">(</span><span class="n">temp_mask</span><span class="p">,</span> <span class="n">burn_mask</span><span class="p">)</span>
    <span class="n">disease_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">bitwise_or</span><span class="p">(</span><span class="n">disease_mask</span><span class="p">,</span> <span class="n">chlorosis_mask</span><span class="p">)</span>

    <span class="c1"># Smooth out edges and close gaps in mask
</span>    <span class="n">kh</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="p">[</span><span class="nf">max</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="nf">int</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)))</span> <span class="o">|</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">getStructuringElement</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="p">(</span><span class="n">kh</span><span class="p">,</span> <span class="n">kw</span><span class="p">))</span>
    <span class="n">disease_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">morphologyEx</span><span class="p">(</span><span class="n">disease_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="n">disease_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">morphologyEx</span><span class="p">(</span><span class="n">disease_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span>  <span class="n">kernel</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">disease_mask</span>
</code></pre></div></div> <h2 id="3-crop-segments-made-by-sam">3. Crop Segments Made by SAM</h2> <p>Function responsible for cropping segments with a minimum size and retaining information.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MIN_SIZE</span> <span class="o">=</span> <span class="mi">256</span>          <span class="c1"># smallest crop side you allow
</span>
<span class="k">def</span> <span class="nf">_cluster_bboxes</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">min_size</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Greedy one-pass clustering:
        – Start a new cluster for each bbox that cannot fit into an existing one.
        – A bbox fits an existing cluster if the *union* of the two
          is ≤ min_size in both width and height.
    Returns: list of dicts  { </span><span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span><span class="s">: (x1,y1,x2,y2), </span><span class="sh">"</span><span class="s">indices</span><span class="sh">"</span><span class="s">: [i,…] }
    </span><span class="sh">"""</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">bboxes</span><span class="p">):</span>
        <span class="n">placed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="n">cx1</span><span class="p">,</span><span class="n">cy1</span><span class="p">,</span><span class="n">cx2</span><span class="p">,</span><span class="n">cy2</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">ux1</span><span class="p">,</span> <span class="n">uy1</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">cx1</span><span class="p">,</span><span class="n">x1</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">cy1</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span>
            <span class="n">ux2</span><span class="p">,</span> <span class="n">uy2</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">cx2</span><span class="p">,</span><span class="n">x2</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">cy2</span><span class="p">,</span><span class="n">y2</span><span class="p">)</span>
            <span class="nf">if </span><span class="p">(</span><span class="n">ux2</span><span class="o">-</span><span class="n">ux1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">min_size</span> <span class="ow">and</span> <span class="p">(</span><span class="n">uy2</span><span class="o">-</span><span class="n">uy1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">min_size</span><span class="p">:</span>
                <span class="n">cl</span><span class="p">[</span><span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">ux1</span><span class="p">,</span> <span class="n">uy1</span><span class="p">,</span> <span class="n">ux2</span><span class="p">,</span> <span class="n">uy2</span><span class="p">)</span>
                <span class="n">cl</span><span class="p">[</span><span class="sh">"</span><span class="s">indices</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">placed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">placed</span><span class="p">:</span>
            <span class="n">clusters</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span><span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">),</span> <span class="sh">"</span><span class="s">indices</span><span class="sh">"</span><span class="p">:[</span><span class="n">i</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">clusters</span>


<span class="k">def</span> <span class="nf">_pad_bounds</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">img_w</span><span class="p">,</span> <span class="n">img_h</span><span class="p">,</span> <span class="n">min_size</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Expand bounds to ≥ min_size each side, clamp to image edges.</span><span class="sh">"""</span>
    <span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span> <span class="o">=</span> <span class="n">bounds</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span>

    <span class="c1"># symmetric padding
</span>    <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_size</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">x1</span> <span class="o">-=</span> <span class="n">pad</span><span class="p">;</span>  <span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">min_size</span>
    <span class="k">if</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_size</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">y1</span> <span class="o">-=</span> <span class="n">pad</span><span class="p">;</span>  <span class="n">y2</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">min_size</span>

    <span class="c1"># clip to valid coordinates
</span>    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">img_w</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="nf">min</span><span class="p">(</span><span class="n">img_h</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>

    <span class="c1"># if clipping shrank the box below min_size, shift it back
</span>    <span class="k">if</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>     <span class="n">x2</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">img_w</span><span class="p">,</span> <span class="n">min_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>           <span class="n">x1</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">min_size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>     <span class="n">y2</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">img_h</span><span class="p">,</span> <span class="n">min_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>           <span class="n">y1</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">min_size</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">crop_segments</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">filtered_masks</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">min_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MIN_SIZE</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    image           : H×W[×C] NumPy array
    filtered_masks  : list of SAM annotations, each containing </span><span class="sh">'</span><span class="s">bbox</span><span class="sh">'</span><span class="s"> = [x, y, w, h]
    Returns         : list of dicts: { </span><span class="sh">"</span><span class="s">crop</span><span class="sh">"</span><span class="s">: np.ndarray, </span><span class="sh">"</span><span class="s">anns</span><span class="sh">"</span><span class="s">: [ann, …], </span><span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span><span class="s">: (x1,y1,x2,y2) }
    </span><span class="sh">"""</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># collect (x1,y1,x2,y2) for every ann
</span>    <span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">bx</span><span class="p">),</span> <span class="nf">int</span><span class="p">(</span><span class="n">by</span><span class="p">),</span> <span class="nf">int</span><span class="p">(</span><span class="n">bx</span><span class="o">+</span><span class="n">bw</span><span class="p">),</span> <span class="nf">int</span><span class="p">(</span><span class="n">by</span><span class="o">+</span><span class="n">bh</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">filtered_masks</span>
        <span class="k">for</span> <span class="n">bx</span><span class="p">,</span><span class="n">by</span><span class="p">,</span><span class="n">bw</span><span class="p">,</span><span class="n">bh</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ann</span><span class="p">[</span><span class="sh">"</span><span class="s">bbox</span><span class="sh">"</span><span class="p">]]</span>
    <span class="p">]</span>

    <span class="c1"># greedy clustering so that each cluster fits inside a min_size square
</span>    <span class="n">clusters</span> <span class="o">=</span> <span class="nf">_cluster_bboxes</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">min_size</span><span class="p">)</span>

    <span class="c1"># pad each cluster to at least min_size and extract the crop
</span>    <span class="n">crops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span> <span class="o">=</span> <span class="nf">_pad_bounds</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span><span class="p">],</span> <span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">min_size</span><span class="p">)</span>
        <span class="n">crop_img</span>    <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span>
        <span class="n">crop_anns</span>   <span class="o">=</span> <span class="p">[</span><span class="n">filtered_masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">[</span><span class="sh">"</span><span class="s">indices</span><span class="sh">"</span><span class="p">]]</span>

        <span class="n">crops</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">crop</span><span class="sh">"</span>   <span class="p">:</span> <span class="n">crop_img</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">anns</span><span class="sh">"</span>   <span class="p">:</span> <span class="n">crop_anns</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span> <span class="p">:</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">crops</span>

</code></pre></div></div> <h1 id="automatic-mask-generation">Automatic Mask Generation</h1> <h2 id="instantiate-sam">Instantiate SAM</h2> <p>We’ll instantiate the mask generator in accordance with our needs. First, we’ll enable it look at more fine grained details in the images (crops) as diseases could sometimes be small (i.e. spots).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">segment_anything</span> <span class="kn">import</span> <span class="n">sam_model_registry</span><span class="p">,</span> <span class="n">SamAutomaticMaskGenerator</span><span class="p">,</span> <span class="n">SamPredictor</span>

<span class="c1"># We'll load the model using the checkpoint we got
</span><span class="n">sam_checkpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">sam_vit_h_4b8939.pth</span><span class="sh">"</span>
<span class="n">model_type</span> <span class="o">=</span> <span class="sh">"</span><span class="s">vit_h</span><span class="sh">"</span>

<span class="n">sam</span> <span class="o">=</span> <span class="n">sam_model_registry</span><span class="p">[</span><span class="n">model_type</span><span class="p">](</span><span class="n">checkpoint</span><span class="o">=</span><span class="n">sam_checkpoint</span><span class="p">)</span>
<span class="n">sam</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>

<span class="n">mask_generator</span> <span class="o">=</span> <span class="nc">SamAutomaticMaskGenerator</span><span class="p">(</span>
    <span class="n">sam</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div> <h2 id="prepare-test-images">Prepare test images</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">mkdir</span> <span class="n">images</span>
<span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">P</span> <span class="n">images</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="p">.</span><span class="n">githubusercontent</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">abodeza</span><span class="o">/</span><span class="n">plant_disease_detection</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">test_imgs</span><span class="o">/</span><span class="n">Aziz_crop</span><span class="p">.</span><span class="n">jpg</span>
<span class="err">!</span><span class="n">wget</span> <span class="o">-</span><span class="n">P</span> <span class="n">images</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="p">.</span><span class="n">githubusercontent</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">abodeza</span><span class="o">/</span><span class="n">plant_disease_detection</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">test_imgs</span><span class="o">/</span><span class="n">mildew</span><span class="p">.</span><span class="n">jpg</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We can use the mask generator as such
</span><span class="n">image_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">images/mildew.jpg</span><span class="sh">"</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span>
<span class="n">image_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
</code></pre></div></div> <p>Mask generation returns a list over masks, where each mask is a dictionary containing various data about the mask. These keys are:</p> <ul> <li>segmentation : the mask</li> <li>area : the area of the mask in pixels</li> <li>bbox : the boundary box of the mask in XYWH format</li> <li>predicted_iou : the model’s own prediction for the quality of the mask</li> <li>point_coords : the sampled input point that generated this mask</li> <li>stability_score : an additional measure of mask quality</li> <li>crop_box : the crop of the image used to generate this mask in XYWH format</li> </ul> <p><a href="https://github.com/facebookresearch/segment-anything/blob/main/segment_anything/automatic_mask_generator.py" rel="external nofollow noopener" target="_blank">more details on their repo</a></p> <h2 id="generate-masks">Generate masks</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">masks</span> <span class="o">=</span> <span class="n">mask_generator</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</code></pre></div></div> <h2 id="lets-visualize-the-automatically-generated-masks">Let’s visualize the automatically generated masks</h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Left: image only
</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Original Image</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Right: image + annotations
</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">sca</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># set current axis
</span><span class="nf">show_anns</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Image with Annotations</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/gharsa/gharsa_eye_v1.0_25_0-480.webp 480w,/assets/img/gharsa/gharsa_eye_v1.0_25_0-800.webp 800w,/assets/img/gharsa/gharsa_eye_v1.0_25_0-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/gharsa/gharsa_eye_v1.0_25_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="VRF Diagram" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h2 id="we-can-do-better">We can do better</h2> <p>The masks generated by SAM automatically are impressive, but we care mostly about the diseased areas.</p> <p>We will create a color mask that highlights possibly diseased areas and choose the SAM masks that best align with it.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">disease_mask</span> <span class="o">=</span> <span class="nf">color_mask</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span>
<span class="n">filtered_masks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">segmentation</span><span class="sh">"</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="sh">"</span><span class="s">uint8</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">inter</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">count_nonzero</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">disease_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">inter</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">count_nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">filtered_masks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>               <span class="c1"># keep only good masks
</span></code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Left: image + all annotations
</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">sca</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># set current axis
</span><span class="nf">show_anns</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Image + All Annotations</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Right: image + filtered annotations
</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">sca</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># set current axis
</span><span class="nf">show_anns</span><span class="p">(</span><span class="n">filtered_masks</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Image + Filtered Annotations</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/gharsa/gharsa_eye_v1.0_28_0-480.webp 480w,/assets/img/gharsa/gharsa_eye_v1.0_28_0-800.webp 800w,/assets/img/gharsa/gharsa_eye_v1.0_28_0-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/gharsa/gharsa_eye_v1.0_28_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="VRF Diagram" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h2 id="crop-segments-for-analysis">Crop segments for analysis</h2> <p>SAM returns the bounding box coordinates for each mask. If we were to crop each segment directly, some might be too small for later analysis. Hence, we’ll ensure the crops are large enough and not overlapping.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">crops</span> <span class="o">=</span> <span class="nf">crop_segments</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filtered_masks</span><span class="p">)</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">show_crops</span><span class="p">(</span><span class="n">crops</span><span class="p">,</span> <span class="n">max_cols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">)):</span>
    <span class="sh">"""</span><span class="s">
    crops: output of `crop_segments`, list of dicts with keys </span><span class="sh">'</span><span class="s">crop</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">anns</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">bounds</span><span class="sh">'</span><span class="s">
    max_cols: max number of columns in the plot grid
    </span><span class="sh">"""</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">crops</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">max_cols</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="n">cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">cols</span>

    <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">crop_data</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">crops</span><span class="p">):</span>
        <span class="n">crop</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">[</span><span class="sh">'</span><span class="s">crop</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">anns</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">[</span><span class="sh">'</span><span class="s">anns</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">[</span><span class="sh">'</span><span class="s">bounds</span><span class="sh">'</span><span class="p">]</span>

        <span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">crop</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">anns</span><span class="p">)</span><span class="si">}</span><span class="s"> mask(s)</span><span class="se">\n</span><span class="si">{</span><span class="n">bounds</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
<span class="nf">show_crops</span><span class="p">(</span><span class="n">crops</span><span class="p">)</span>

</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/gharsa/gharsa_eye_v1.0_31_0-480.webp 480w,/assets/img/gharsa/gharsa_eye_v1.0_31_0-800.webp 800w,/assets/img/gharsa/gharsa_eye_v1.0_31_0-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/gharsa/gharsa_eye_v1.0_31_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="VRF Diagram" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h1 id="load-and-setup-clip">Load and setup CLIP</h1> <p>CLIP is trained on image and textual description pairs. Thus, it’s able to measure the closeness of textual prompts with images.</p> <p>Furthermore, I have finetuned CLIP on the 5 supported disease classes and ~100 images per class making it better suited for the task.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. PROMPT BANK &amp; LOADING CLIP MODEL
</span><span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="n">cv2</span><span class="p">,</span> <span class="n">torch</span><span class="p">,</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span><span class="p">,</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>

<span class="n">prompt_bank</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">Rot</span><span class="sh">"</span><span class="p">:</span>                 <span class="p">[</span><span class="sh">"</span><span class="s">rot</span><span class="sh">"</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">Spot</span><span class="sh">"</span><span class="p">:</span>                <span class="p">[</span><span class="sh">"</span><span class="s">spot</span><span class="sh">"</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">Burn</span><span class="sh">"</span><span class="p">:</span>                <span class="p">[</span><span class="sh">"</span><span class="s">burn</span><span class="sh">"</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">Powdery Mildew</span><span class="sh">"</span><span class="p">:</span>      <span class="p">[</span><span class="sh">"</span><span class="s">powdery_mildew</span><span class="sh">"</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">Nutrient Deficiency</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">chlorosis</span><span class="sh">"</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">flat_prompts</span>  <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">prompt_bank</span><span class="p">.</span><span class="nf">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>
<span class="n">prompt_class</span>  <span class="o">=</span> <span class="p">[</span><span class="n">cls</span> <span class="k">for</span> <span class="n">cls</span><span class="p">,</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">prompt_bank</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>

<span class="n">device</span>       <span class="o">=</span> <span class="sh">"</span><span class="s">cuda</span><span class="sh">"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="sh">"</span><span class="s">cpu</span><span class="sh">"</span>
<span class="n">clip_model</span>   <span class="o">=</span> <span class="nc">SentenceTransformer</span><span class="p">(</span><span class="sh">"</span><span class="s">abodeza/clip-ViT-B-32-leaf-disease</span><span class="sh">"</span><span class="p">,</span>
                                   <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
    <span class="n">text_feats</span> <span class="o">=</span> <span class="n">clip_model</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">flat_prompts</span><span class="p">,</span>
                                   <span class="n">convert_to_tensor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                   <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">text_feats</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">normalize</span><span class="p">(</span><span class="n">text_feats</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#  2. CLASSIFY CROPS &amp; SAVE RESULTS
</span><span class="n">CLIP_THRESH</span> <span class="o">=</span> <span class="mf">0.3</span>          <span class="c1"># confidence cut-off
</span><span class="n">OUT_DIR</span>     <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="sh">"</span><span class="s">crops_out</span><span class="sh">"</span><span class="p">)</span>
<span class="n">OUT_DIR</span><span class="p">.</span><span class="nf">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">selected</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">prompt_bank</span><span class="p">}</span>    <span class="c1"># store results per class
</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">crop_dict</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">crops</span><span class="p">):</span>      <span class="c1"># ‘crops’ comes from crop_segments
</span>    <span class="n">crop_img</span>  <span class="o">=</span> <span class="n">crop_dict</span><span class="p">[</span><span class="sh">"</span><span class="s">crop</span><span class="sh">"</span><span class="p">]</span>          <span class="c1"># H×W×C, RGB
</span>    <span class="n">pil_crop</span>  <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nf">fromarray</span><span class="p">(</span><span class="n">crop_img</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
        <span class="n">feat</span>   <span class="o">=</span> <span class="n">clip_model</span><span class="p">.</span><span class="nf">encode</span><span class="p">([</span><span class="n">pil_crop</span><span class="p">],</span> <span class="n">convert_to_tensor</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                   <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">feat</span>   <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">normalize</span><span class="p">(</span><span class="n">feat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sims</span>   <span class="o">=</span> <span class="p">(</span><span class="n">feat</span> <span class="o">@</span> <span class="n">text_feats</span><span class="p">.</span><span class="n">T</span><span class="p">).</span><span class="nf">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">best_idx</span>   <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">sims</span><span class="p">))</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">sims</span><span class="p">[</span><span class="n">best_idx</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">best_score</span> <span class="o">&lt;</span> <span class="n">CLIP_THRESH</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="n">cls_name</span>  <span class="o">=</span> <span class="n">prompt_class</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">crop_</span><span class="si">{</span><span class="n">j</span><span class="si">:</span><span class="mi">03</span><span class="n">d</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">cls_name</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">.png</span><span class="sh">"</span>
    <span class="n">cv2</span><span class="p">.</span><span class="nf">imwrite</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">OUT_DIR</span> <span class="o">/</span> <span class="n">file_name</span><span class="p">),</span>
                <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">crop_img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_RGB2BGR</span><span class="p">))</span>

    <span class="n">selected</span><span class="p">[</span><span class="n">cls_name</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">:</span>   <span class="n">file_name</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">:</span>  <span class="n">best_score</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span><span class="p">:</span> <span class="n">crop_dict</span><span class="p">[</span><span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span><span class="p">],</span>
    <span class="p">})</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="nf">sum</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">.</span><span class="nf">values</span><span class="p">())</span><span class="si">}</span><span class="s"> crops saved at </span><span class="si">{</span><span class="n">OUT_DIR</span><span class="p">.</span><span class="nf">resolve</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cls</span><span class="p">,</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">cls</span><span class="si">:</span><span class="mi">20</span><span class="n">s</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3 crops saved at /content/crops_out
Rot                 : 0
Spot                : 0
Burn                : 0
Powdery Mildew      : 3
Nutrient Deficiency : 0
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 3. VISUAL SUMMARY OF THE PIPELINE
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># (a) Disease-mask overlay
</span><span class="n">overlay</span> <span class="o">=</span> <span class="n">image_rgb</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">overlay</span><span class="p">[</span><span class="n">disease_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">overlay</span><span class="p">[</span><span class="n">disease_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Disease mask</span><span class="sh">"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># (b) SAM segment contours
</span><span class="n">vis</span> <span class="o">=</span> <span class="n">image_rgb</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">filtered_masks</span><span class="p">:</span>
    <span class="n">cnts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">findContours</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="sh">"</span><span class="s">segmentation</span><span class="sh">"</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">),</span>
                               <span class="n">cv2</span><span class="p">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="nf">drawContours</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">cnts</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">vis</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">SAM segments</span><span class="sh">"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># (c) Crops + CLIP labels
</span><span class="n">final_vis</span> <span class="o">=</span> <span class="n">image_rgb</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">cls</span><span class="p">,</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="sh">"</span><span class="s">bounds</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">cv2</span><span class="p">.</span><span class="nf">rectangle</span><span class="p">(</span><span class="n">final_vis</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cv2</span><span class="p">.</span><span class="nf">putText</span><span class="p">(</span><span class="n">final_vis</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y1</span><span class="o">-</span><span class="mi">4</span><span class="p">)),</span>
                    <span class="n">cv2</span><span class="p">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">final_vis</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Crops &amp; CLIP labels</span><span class="sh">"</span><span class="p">);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/gharsa/gharsa_eye_v1.0_35_0-480.webp 480w,/assets/img/gharsa/gharsa_eye_v1.0_35_0-800.webp 800w,/assets/img/gharsa/gharsa_eye_v1.0_35_0-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/gharsa/gharsa_eye_v1.0_35_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="VRF Diagram" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 4. TOP-SCORING CROPS
</span><span class="n">TOP_K_VIZ</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">cls</span><span class="p">,</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lst</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">lst</span><span class="p">.</span><span class="nf">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="sh">"</span><span class="s">score</span><span class="sh">"</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">lst</span><span class="p">),</span> <span class="n">TOP_K_VIZ</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">[:</span><span class="n">n</span><span class="p">]):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">OUT_DIR</span> <span class="o">/</span> <span class="n">entry</span><span class="p">[</span><span class="sh">"</span><span class="s">file</span><span class="sh">"</span><span class="p">])),</span>
                           <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">);</span> <span class="n">plt</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="sh">"</span><span class="s">off</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">cls</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">cls</span><span class="si">}</span><span class="s"> – top </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/gharsa/gharsa_eye_v1.0_36_0-480.webp 480w,/assets/img/gharsa/gharsa_eye_v1.0_36_0-800.webp 800w,/assets/img/gharsa/gharsa_eye_v1.0_36_0-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/gharsa/gharsa_eye_v1.0_36_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="VRF Diagram" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Now we have reached the end of the notebook. We went through color masking, SAM’s automatic mask generation and CLIP’s image-text pairs automating the task of locating, and accurately classifying the diseases on plant leaves.</p> <p>The next steps are to simplify the pipeline further to fit into one function that can be called once. Additionally, I’m working on producing the same promising results for all the other diseases.</p> <p>Please don’t hesitate to reach out with any questions!</p> <h1 id="full-pipeline-wip">Full pipeline [WIP]</h1> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div> <h1 id="more-examples-wip">More examples [WIP]</h1> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div> <h1 id="resources">Resources</h1> <ol> <li><a href="https://docs.opencv.org/4.x/d3/db4/tutorial_py_watershed.html" rel="external nofollow noopener" target="_blank">OpenCV Color Filters</a></li> <li><a href="https://docs.opencv.org/4.11.0/d4/d73/tutorial_py_contours_begin.html" rel="external nofollow noopener" target="_blank">OpenCV Contour</a></li> <li><a href="https://github.com/facebookresearch/segment-anything/blob/main/notebooks/automatic_mask_generator_example.ipynb" rel="external nofollow noopener" target="_blank">Automatic mask generator (SAM) example</a></li> <li><a href="https://github.com/facebookresearch/segment-anything" rel="external nofollow noopener" target="_blank">SAM’s repo</a></li> <li><a href="https://github.com/openai/CLIP?search=1" rel="external nofollow noopener" target="_blank">CLIP’s Repo</a></li> </ol> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Abdullah Ahmed Alzahrani. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. This site uses Google Analytics to measure anonymous engagement. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-CZKWWGTH6B"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-CZKWWGTH6B');
  </script> <script defer src="/assets/js/google-analytics-setup.js"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>